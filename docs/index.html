<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>[REX] Migrez efficacement vos Jobs CI Maven en Pipeline Docker avec Jenkins 2</title>
<meta name="author" content="Maxime Gréau">
<meta name="generator" content="Asciidoctor 1.5.4 (Bespoke.js converter)">
<meta name="mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="build/build.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
</head>
<body>
<article class="deck">
<section class="title" data-title="">
<h1>[REX] Migrez efficacement vos Jobs CI Maven en Pipeline Docker avec Jenkins 2</h1>
<footer>
<p class="author"><span class="personname"><span class="firstname">Maxime</span> <span class="surname">Gréau</span></span><span class="affiliation"><span class="position">Senior Sofwtare Engineer</span> <span class="organization">eXo Platform</span></span></p>
</footer>
</section>
<section class="closing segue badge-right">
<h2>About me, eXo, me@eXo</h2>
</section>
<section>
<h2>Maxime Gréau - @mgreau</h2>
<div class="columns-2 float-group">
<ul class="left">
<li><span class="primary"><strong>Senior Software Engineer</strong></span>
<ul>
<li><span class="primary">@ <strong>eXo</strong> since 2015</span></li>
</ul>
</li>
<li><span class="primary">2010-2015 - Architect DGFIP</span></li>
<li><span class="primary">Before 2010 - Software Developer</span></li>
<li><span class="primary">Book Author</span>
<ul>
<li><span class="primary"><strong>2011</strong>: Apache Maven 3</span></li>
</ul>
</li>
<li><span class="primary">Open Source</span>
<ul>
<li><span class="primary">Asciidoctor</span></li>
</ul>
</li>
<li><span class="primary">Speaker</span>
<ul>
<li><span class="primary">Devoxx, DevNation, DevFest, JUG&#8230;&#8203;</span></li>
</ul>
</li>
</ul>
<figure class="image reflect"><img src="images/mgreau-profile.png" alt="@mgreau profile" width="300"></figure>
</div>
<ul class="horizontal contact">
<li><span class="primary"><a href="https://twitter.com/mgreau">@mgreau</a><br></span></li>
<li><span class="primary"><a href="http://mgreau.com/posts">mgreau.com/blog</a></span></li>
</ul>
</section>
<section>
<h2>eXo at a glance</h2>
<figure class="image crux"><img src="images/exo-at-a-glance.png" alt="eXo at a glance" width="900"></figure>
</section>
<section>
<h2>What is eXo Platform?</h2>
<div class="columns-2 float-group">
<ul class="left">
<li><span class="primary">Open Source</span>
<ul>
<li><span class="primary"><a href="https://github.com/exoplatform">eXo Platform - GitHub</a></span></li>
<li><span class="primary"><a href="https://github.com/exo-addons">eXo Add-ons - GitHub</a></span></li>
</ul>
</li>
<li><span class="primary">Enterprise class</span></li>
<li><span class="primary">Digital Collaboration</span></li>
<li><span class="primary">Platform</span></li>
</ul>
<figure class="image reflect"><img src="images/exo-platform.png" alt="eXo Platform" width="500"></figure>
</div>
</section>
<section>
<h2>Software Factory Overview</h2>
<figure class="image crux"><img src="images/exo-swf-base.svg" alt="eXo SWF"></figure>
</section>
<section class="closing segue badge-right">
<h2>What do we have to build?</h2>
</section>
<section>
<h2>Platform Components &amp; Add-ons</h2>
<div class="columns-2 compact float-group">
<figure class="image left"><img src="images/exo-plf-components.png" alt="eXo PLF Components" width="600"></figure>
<ul class="left">
<li><span class="primary">More than <strong>20 components</strong> to build</span>
<ul>
<li><span class="primary">Platform projects</span></li>
<li><span class="primary">GateIn projects</span></li>
<li><span class="primary">Juzu projects</span></li>
</ul>
</li>
<li><span class="primary">Lots of Add-ons</span>
<ul>
<li><span class="primary">15+ supported Add-ons</span></li>
<li><span class="primary"><strong>100+</strong> community Add-ons</span></li>
</ul>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">1 component = 1 <strong>multi-module</strong> Maven project</td>
</tr>
</table>
</div>
</section>
<section>
<h2>Platform versions and Clients</h2>
<ul>
<li><span class="primary">Since 2003, several Platform versions</span>
<ul>
<li><span class="primary">eXo Platform 3.x (3.0 / 3.5)</span></li>
<li><span class="primary">eXo Platform 4.x (4.0, 4.1, 4.2, 4.3, 4.4)</span></li>
</ul>
</li>
<li><span class="primary">Several versions = multiple stacks (run &amp; build)</span>
<ul>
<li><span class="primary">Java 6 / Java 7 / Java 8&#8230;&#8203;</span></li>
<li><span class="primary">Maven 3.0 / Maven 3.2&#8230;&#8203;</span></li>
</ul>
</li>
<li><span class="primary">Clients don&#8217;t update their instances each year</span></li>
</ul>
</section>
<section>
<h2>Git Workflow</h2>
<div class="columns-2 float-group">
<figure class="image reflect"><img src="images/exo-git-workflow.png" alt="eXo git workflow" width="500"></figure>
<ul class="left">
<li><span class="primary"><strong>develop</strong></span></li>
<li><span class="primary"><strong>stable</strong>:</span>
<ul>
<li><span class="primary">stable/1.x stable/4.3.x stable/4.2.x</span></li>
</ul>
</li>
<li><span class="primary"><strong>feature</strong></span>
<ul>
<li><span class="primary">feature/&lt;feature-name&gt;</span></li>
</ul>
</li>
<li><span class="primary"><strong>fix</strong></span>
<ul>
<li><span class="primary">fix/&lt;issue-id&gt;</span></li>
</ul>
</li>
<li><span class="primary"><strong>integration</strong></span></li>
<li><span class="primary">&#8230;&#8203;</span></li>
</ul>
</div>
<p class="contact"><a href="http://developer.exoplatform.org" class="bare">http://developer.exoplatform.org</a></p>
</section>
<section>
<h2>Remembered how to create a Maven Jenkins Job?</h2>
<figure class="image crux"><img src="images/jenkins2-maven-job-ui.png" alt="Jenkins Maven Job" width="900"></figure>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Yes, this is only ONE job!</td>
</tr>
</table>
</div>
</section>
<section>
<h2>Jobs type</h2>
<ul>
<li><span class="primary"><strong>450+</strong> CI jobs <strong>(&lt;project&gt;-&lt;branch&gt;-ci)</strong></span>
<ul>
<li><span class="primary">for all major branches (develop, stable, features)</span></li>
<li><span class="primary">for some important fix</span></li>
</ul>
</li>
<li><span class="primary"><strong>50+</strong> Sonar jobs <strong>(&lt;project&gt;-&lt;branch&gt;-sonar)</strong></span>
<ul>
<li><span class="primary">for all develop branches</span></li>
</ul>
</li>
<li><span class="primary"><strong>30+</strong> Maven Site jobs</span>
<ul>
<li><span class="primary">for all Platform project</span></li>
</ul>
</li>
<li><span class="primary">Translation jobs</span></li>
<li><span class="primary">&#8230;&#8203;</span></li>
</ul>
</section>
<section>
<h2>Me when I had to use the Jenkins UI</h2>
<figure class="image crux"><img src="images/jenkins-clic-hell.gif" alt="jenkins UI" width="350"></figure>
</section>
<section class="inverse">
<figure class="quote tada">
<blockquote>
<p>If you start to feel like your are a toaster&#8230;&#8203;AUTOMATE!! <span class="image reflect"><img src="images/toaster.gif" alt="toaster" width="450"></span></p>
</blockquote>
<figcaption>Quentin Adam <cite>Clever Cloud</cite></figcaption>
</figure>
</section>
<section class="closing segue badge-bottom">
<h2>Jenkins DSL and Pipeline jobs with Docker to the rescue!</h2>
<p><span class="image"><img src="images/jenkins-logo.png" alt="jenkins" width="150"></span> <span class="image"><img src="images/docker-logo.png" alt="docker" width="230"></span></p>
</section>
<section class="inverse subject">
<h2>1- Create your own CI Docker Images</h2>
<figure class="image crux logo"><img src="images/exo-ci-dockerhub.png" alt="eXo Dockerhub Components" width="650"></figure>
</section>
<section>
<h2>Build stacks</h2>
<div class="columns-2 float-group">
<figure class="image left"><img src="images/exo-docker-github-ci.png" alt="eXo Docker GitHub" width="530"></figure>
<ul class="left">
<li><span class="primary">What we need?</span>
<ul>
<li><span class="primary">Git</span></li>
<li><span class="primary">Maven</span></li>
</ul>
</li>
<li><span class="primary"><strong>eXo CI Images</strong></span>
<ul>
<li><span class="primary">exoplatform/ci:jdk6-maven30</span></li>
<li><span class="primary">exoplatform/ci:jdk7-maven30</span></li>
<li><span class="primary">exoplatform/ci:jdk7-maven32</span></li>
<li><span class="primary">exoplatform/ci:jdk8-maven30</span></li>
<li><span class="primary">exoplatform/ci:jdk8-maven32</span></li>
</ul>
</li>
</ul>
</div>
<p class="contact"><a href="https://github.com/exo-docker/exo-ci" class="bare">https://github.com/exo-docker/exo-ci</a></p>
</section>
<section class="compact">
<header>
<h2>Docker Image for Jenkins</h2>
<h3>entrypoint and cat command</h3>
</header>
<ul>
<li><span class="primary">Example Jenkins job running docker container</span></li>
</ul>
<pre class="source"><code data-lang="BEFORE" class="language-BEFORE prettyprint">$ docker run ... -e ******** exoplatform/ci:jdk7-maven32 cat</code></pre>

<pre class="source"><code data-lang="NOW" class="language-NOW prettyprint">$ docker run ... -e ******** --entrypoint cat exoplatform/ci:jdk7-maven32</code></pre>

<p>FIXED? <a href="https://issues.jenkins-ci.org/browse/JENKINS-33149" class="bare">https://issues.jenkins-ci.org/browse/JENKINS-33149</a></p>
<pre class="source"><code data-lang="shell" class="language-shell prettyprint"># Workaround to be able to execute others command than "mvn" as entrypoint
ENTRYPOINT ["/usr/bin/docker-entrypoint"]

CMD ["mvn", "--help"]</code></pre>

<ul>
<li><span class="primary">docker-entrypoint.sh</span></li>
</ul>
<pre class="source"><code data-lang="shell" class="language-shell prettyprint"># Hack for Jenkins Pipeline: authorize cat without absolute path
if [[ "$1" == "/"* ]] || [[ "$1" == "cat" ]]; then
  exec "$@"
fi

exec mvn "$@"</code></pre>
</section>
<section>
<header>
<h2>Docker Image for Jenkins</h2>
<h3>the user</h3>
</header>
<ul>
<li><span class="primary">Create the same user in the image and in the server</span></li>
</ul>
<pre class="source"><code data-lang="shell" class="language-shell prettyprint"># Create user and group with specific ids
RUN useradd --create-home --user-group -u 13000 --shell /bin/bash ${EXO_CI_USER}</code></pre>

<ul>
<li><span class="primary">Jenkins starting a container</span></li>
</ul>
<pre class="source"><code data-lang="shell" class="language-shell prettyprint">$ docker run -t -d -u 13000:13000
... -v m2-cache-PLF-4.2.x-ecms-4.2.x-ci:/home/ciagent/.m2/repository
...  -e ******** --entrypoint cat exoplatform/ci:jdk7-maven32</code></pre>
</section>
<section>
<header>
<h2>Docker Image for Jenkins</h2>
<h3>Define the locale</h3>
</header>
<pre class="source"><code data-lang="shell" class="language-shell prettyprint"># Set the locale
RUN locale-gen en_US.UTF-8
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US:en
ENV LC_ALL en_US.UTF-8</code></pre>
</section>
<section class="inverse subject">
<h2>2- Use Jenkins Pipeline/Docker plugins</h2>
<pre class="source"><code data-lang="groovy" class="language-groovy prettyprint">node('docker'){
    exoCI{
        dockerImage = 'exoplatform/ci:jdk8-maven32'
        gitUrl = 'git@github.com:exodev/platform-ui.git'
        gitBranch = 'develop'
    }
}</code></pre>
</section>
<section>
<h2>Plugins to use</h2>
<ul>
<li><span class="primary">Pipeline/Docker plugins</span>
<ul>
<li><span class="primary"><a href="http://wiki.jenkins-ci.org/display/JENKINS/CloudBees+Docker+Pipeline+Plugin">CloudBees Docker Pipeline</a></span></li>
<li><span class="primary"><a href="https://wiki.jenkins-ci.org/display/JENKINS/Docker+Commons+Plugin">Docker Commons Plugin</a></span></li>
<li><span class="primary"><a href="https://wiki.jenkins-ci.org/display/JENKINS/Pipeline+Plugin">Pipeline</a></span></li>
<li><span class="primary">Pipeline-*</span></li>
</ul>
</li>
<li><span class="primary"><a href="https://wiki.jenkins-ci.org/display/JENKINS/Pipeline+Shared+Groovy+Libraries+Plugin"><strong>Pipeline: Shared Groovy Libraries</strong></a></span></li>
<li><span class="primary">Others useful plugins</span>
<ul>
<li><span class="primary"><a href="https://wiki.jenkins-ci.org/display/JENKINS/Config+File+Provider+Plugin">Config File Provider Plugin</a></span></li>
<li><span class="primary"><a href="https://wiki.jenkins-ci.org/display/JENKINS/EnvInject+Plugin">Environment Injector Plugin</a></span></li>
</ul>
</li>
</ul>
</section>
<section class="compact">
<h2><strong>Pipeline Shared Groovy Libraries</strong></h2>
<div class="columns-2 float-group">
<ul class="left">
<li><span class="primary"><strong>Create your Groovy scripts</strong></span>
<ul>
<li><span class="primary">src/org/exoplatform/swf/ExoSWFCommands.groovy</span></li>
<li><span class="primary">vars/exoCI.groovy</span></li>
<li><span class="primary">vars/exoCI.txt (doc)</span></li>
<li><span class="primary">vars/exoSonar.groovy</span></li>
<li><span class="primary">vars/exoSonar.txt (doc)</span></li>
<li><span class="primary">vars/mailNotification.groovy</span></li>
</ul>
</li>
<li><span class="primary"><strong>Manage as a code</strong></span>
<ul>
<li><span class="primary">external github repository for now</span></li>
</ul>
</li>
</ul>
<figure class="image left"><img src="images/swf-pipeline-libs.png" alt="eXo Pipeline libs" width="300"></figure>
</div>
</section>
<section class="compact">
<h2><strong>Pipeline Shared Groovy Libraries</strong></h2>
<figure class="listing">
<figcaption>vars/exoSonar.groovy</figcaption>
<pre class="source"><code data-lang="groovy" class="language-groovy prettyprint">    def exoSWF = new org.exoplatform.swf.ExoSWFCommands()
    def utils = new org.exoplatform.swf.Utils()

    //init values
    def M2_REPO_IN_CONTAINER = utils.getValue('m2RepositoryPath', '/home/ciagent/.m2/repository', config, env)
    def JOB_SUFFIX = utils.getValue('jobSuffix', 'sonar', config, env)</code></pre>
</figure>
<pre class="source"><code data-lang="groovy" class="language-groovy prettyprint">              eXoJDKMaven.inside("${DOCKER_RUN_PARAMS} -v ${m2Cache}:${M2_REPO_IN_CONTAINER}") {
                // Build project
                echo "Maven Build"
                sh "mvn ${MAVEN_SONAR_GOALS} -P${MAVEN_SONAR_PROFILES} -s settings.xml"
              }
              exoDockerSonarImage.inside("${DOCKER_RUN_PARAMS} -v ${m2Cache}:${M2_REPO_IN_CONTAINER}") {
                // Execute sonar Analysis
                echo "Sonar Scanner"
                sh "mvn org.sonarsource.scanner.maven:sonar-maven-plugin:${SONAR_PLUGIN_VERSION}:sonar
                -P${MAVEN_SONAR_PROFILES} -s settings.xml"</code></pre>

<pre class="source"><code data-lang="groovy" class="language-groovy prettyprint">    stage('Send Notifications'){
      // Send notification to inform about Build status
      mailNotification(env,currentBuild, mailTo)
      // Add comment to JIRA
      jiraNotification(env,currentBuild)
    }</code></pre>

<p><a href="http://localhost:8888/job/maven-sandbox-project-ci/pipeline-syntax/globals#exoCI" class="bare">http://localhost:8888/job/maven-sandbox-project-ci/pipeline-syntax/globals#exoCI</a></p>
</section>
<section>
<h2>Notes about Pipeline</h2>
<ul>
<li><span class="primary">Not all plugins are compatible with pipeline yet</span>
<ul>
<li><span class="primary">example: Maven Plugin (deployed at the end)</span></li>
</ul>
</li>
<li><span class="primary">Be careful with Jenkinsfile and security</span>
<ul>
<li><span class="primary">SOON: <em>"• load Jenkinsfile only from trusted PRs; readTrusted"</em></span></li>
</ul>
</li>
<li><span class="primary">Still verbose syntax</span>
<ul>
<li><span class="primary">SOON: <em>"Declarative Pipeline in beta"</em></span></li>
</ul>
</li>
</ul>
<p>See: <a href="https://www.cloudbees.com/sites/default/files/2016-jenkins-world-directions_for_pipeline.pdf">Directions for Pipeline</a> by Jesse Glick at <strong>Jenkins World 2016</strong></p>
</section>
<section>
<header>
<h2>DEMO</h2>
<h3>Pipeline Docker for Sonar Analysis</h3>
</header>
<figure class="image"><img src="images/jenkins-pipeline-sonar.png" alt="eXo Pipeline Sonar" width="500"></figure>
</section>
<section class="inverse subject">
<h2>3- Generate your Pipeline jobs with DSL jobs</h2>
<pre class="source"><code data-lang="groovy" class="language-groovy prettyprint">      triggers {
            scm("${scmValue}")
            cron("${cronValue}")
      }

      definition {
        cps {
          script('''#!groovy
node('docker'){
    exoSonar{}
}
          ''')
        }
      }
    }
}</code></pre>
</section>
<section>
<h2>Pipeline, DSL, Shared Groovy libs</h2>
<figure class="image crux"><img src="images/exo-swf-dsl-pipeline.svg" alt="exo swf dsl pipeline"></figure>
</section>
<section>
<header>
<h2>DEMO</h2>
<h3>Generate all pipeline jobs with DSL jobs</h3>
</header>
<figure class="image"><img src="images/demo-dsl.png" alt="DSL" width="600"></figure>
</section>
<section>
<h2>Now how to create a new Job?</h2>
<pre class="source"><code data-lang="shell" class="language-shell prettyprint">$ git commit -am "Add new Sonar job"
$ git push</code></pre>

<figure class="image"><img src="images/dsl-commit-sonar.png" alt="DSL Commit" width="900"></figure>
</section>
<section>
<header>
<h2>5 seed jobs to generate 450+ jobs</h2>
<h3>then you feel more like&#8230;&#8203;</h3>
</header>
<figure class="image"><img src="images/happy.gif" alt="Jobs DSL Happy" width="500"></figure>
</section>
<section class="inverse subject">
<header>
<h2>What about local builds?</h2>
<h3>use Docker4Mac</h3>
</header>
<figure class="image"><img src="images/docker-for-mac.png" alt="Docker4Mac" width="600"></figure>
</section>
<section class="compact">
<h2>Use your CI Images on your laptop</h2>
<pre class="source"><code data-lang="shell" class="language-shell prettyprint">function jdk7mvn30(){
      docker run --rm -v $(pwd):/srv/ciagent/workspace -v ~/.m2/repository:/home/ciagent/.m2/repository
      -v ~/.m2/settings.xml:/home/ciagent/.m2/settings.xml exoplatform/ci:jdk7-maven30 $*
}


function mvn(){
      docker run --rm -v $(pwd):/srv/ciagent/workspace -v ~/.m2/repository:/home/ciagent/.m2/repository
      -v ~/.m2/settings.xml:/home/ciagent/.m2/settings.xml exoplatform/ci:jdk8-maven32 $*
}</code></pre>

<pre class="source"><code data-lang="shell" class="language-shell prettyprint">$ mvn -v
Apache Maven 3.2.5 (12a6b3acb947671f09b81f49094c53f426d8cea1; 2014-12-14T17:29:23+00:00)
Maven home: /usr/share/maven
Java version: 1.8.0_92, vendor: Oracle Corporation
Java home: /usr/lib/jvm/java-1.8.0_92-oracle-x64/jre
Default locale: en_US, platform encoding: UTF-8
OS name: "linux", version: "4.4.22-moby", arch: "amd64", family: "unix"</code></pre>

<pre class="source"><code data-lang="shell" class="language-shell prettyprint">$ jdk7mvn30 -v
Apache Maven 3.0.5 (r01de14724cdef164cd33c7c8c2fe155faf9602da; 2013-02-19 13:51:28+0000)
Maven home: /usr/share/maven
Java version: 1.7.0_79, vendor: Oracle Corporation
Java home: /usr/lib/jvm/java-1.7.0_79-oracle-x64/jre
Default locale: en_US, platform encoding: UTF-8
OS name: "linux", version: "4.4.22-moby", arch: "amd64", family: "unix"</code></pre>
</section>
<section>
<h2>To sum up</h2>
<ul>
<li><span class="primary">Upgrade to latest Jenkins 1.651.3 then <strong>Jenkins 2 will be easy</strong></span></li>
<li><span class="primary">Create <strong>your CI Docker images for Jenkins</strong></span>
<ul>
<li><span class="primary">use the same images on your laptop and the CI</span></li>
</ul>
</li>
<li><span class="primary"><strong>Pipeline as code</strong></span>
<ul>
<li><span class="primary">create your custom pipeline scripts with <strong>Pipeline: Shared Groovy Libraries</strong></span></li>
</ul>
</li>
<li><span class="primary">Execute <strong>builds into containers</strong></span></li>
<li><span class="primary">Generate Pipeline jobs with DSL jobs</span>
<ul>
<li><span class="primary">manage your <strong>DSL scripts as code</strong></span></li>
</ul>
</li>
<li><span class="primary">Be careful with security &amp; Jenkinsfile</span></li>
<li><span class="primary">Create agent with Docker only</span></li>
<li><span class="primary">Remove executor on master</span></li>
</ul>
</section>
<section class="closing segue badge-right">
<h2>&lt;Thank You!&gt;</h2>
<ul>
<li><span class="primary"><a href="http://mgreau.com/jenkins2-pipeline-maven-docker/"><strong>Slides online</strong></a></span>
<ul>
<li><span class="primary">Slides in <strong>AsciiDoc</strong>, feel free to <a href="https://github.com/mgreau/jenkins2-pipeline-maven-docker/tree/master/s/slides/src">send a PR</a> ;)</span></li>
</ul>
</li>
<li><span class="primary"><a href="https://github.com/mgreau/jenkins2-pipeline-maven-docker/tree/master/i"><strong>Demo files</strong></a></span>
<ul>
<li><span class="primary">Dockerfiles &amp; docker-compose.yml for <strong>Jenkins and Sonar</strong></span></li>
</ul>
</li>
</ul>
<p class="contact">twitter: <a href="https://twitter.com/mgreau">@mgreau</a> - github: <a href="https://github.com/mgreau">@mgreau</a> - <a href="http://mgreau.com/post">mgreau.com</a></p>
</section>
<section class="inverse subject">
<figure class="image logo crux"><img src="images/exo.png" alt="eXo"></figure>
</section>
</article>
<script src="build/build.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script>
<script>Array.prototype.forEach.call(document.querySelectorAll('i.conum+b'),function(n){n.parentNode.removeChild(n)})</script>
<script>prettyPrint()</script>
</body>
</html>
